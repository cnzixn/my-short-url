<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>链接解析</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container">
        <p id="statusText">正在加载链接...</p>
        <div id="qrContent" style="display: none;">
            <div id="qrImage"></div>
            <a id="targetLink" target="_blank">请打开手机浏览器，扫描二维码</a>
        </div>
    </div>

    <script>
        const getPathKey = () => {
            const segments = window.location.pathname.split('/').filter(Boolean);
            return segments.length > 1 ? segments[1] : null;
        };

        const showError = (message) => {
            const statusText = document.getElementById('statusText');
            statusText.textContent = message;
            statusText.style.color = '#e74c3c';
        };

        const init = async () => {
            const key = getPathKey();
            if (!key) {
                showError('无效链接地址');
                return;
            }

            try {
                console.log('[DEBUG] 开始获取短链接:', key);

                const response = await fetch('/.netlify/functions/getLink', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Debug-Key': key
                    },
                    body: JSON.stringify({ key })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`服务响应异常: ${response.status} ${errorText.slice(0, 50)}`);
                }

                const data = await response.json().catch(e => {
                    throw new Error('数据格式错误');
                });

                console.log('[DEBUG] 接收数据:', data);

                // 移动端直接跳转
                const isMobile = /(iPhone|iPad|iPod|Android|webOS|BlackBerry|Windows Phone)/i.test(navigator.userAgent);
                if (isMobile) {
                    console.log('[DEBUG] 移动端跳转至:', data.url);
                    window.location.href = data.url;
                    return;
                }

                // 桌面端显示二维码
                console.log('[DEBUG] 桌面端渲染二维码');

                const qrContent = document.getElementById('qrContent');
                const qrImageDiv = document.getElementById('qrImage');
                const targetLink = document.getElementById('targetLink');

                if (!qrContent || !qrImageDiv || !targetLink) {
                    console.error('[CRITICAL] 关键元素未找到');
                    return;
                }

                // 填充二维码图片
                const img = document.createElement('img');
                img.width = 300;
                img.alt = "QR Code";
                if (data.qrCode.startsWith('data:image/')) {
                    img.src = data.qrCode; // Base64直接用
                } else {
                    img.src = data.qrCode + '?t=' + Date.now(); // 普通URL加时间戳防缓存
                }
                qrImageDiv.appendChild(img);

                // 填充链接
                // targetLink.href = data.url;

                // 显示内容
                qrContent.style.display = 'block';
                document.getElementById('statusText').style.display = 'none';

            } catch (error) {
                console.error('[ERROR] 完整错误链:', error);

                const errorMap = {
                    404: () => `${key}链接不存在`,
                    500: () => '服务暂时不可用',
                    '网络错误': () => '网络连接失败',
                    '数据格式错误': () => '服务器响应异常'
                };

                const getMessage = () => {
                    if (error.message.includes('404')) return errorMap[404]();
                    if (error.message.includes('500')) return errorMap[500]();
                    if (error.message.includes('Failed to fetch')) return errorMap['网络错误']();
                    if (error.message.includes('数据格式错误')) return errorMap['数据格式错误']();
                    return `${key}加载失败，错误代码：${error.message.slice(0, 30)}`;
                };

                showError(getMessage());

                if (!navigator.onLine) {
                    showError('网络连接已断开');
                }
            }
        };

        init();
    </script>
</body>
</html>