<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>618.SH</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
<div class="container">
  <h1>批量短链生成</h1>

  <!-- 新增文件上传组件 -->
  <div class="file-input">
    <label for="fileUpload">或上传 TXT 文件：</label>
    <input type="file" id="fileUpload" accept=".txt" />
  </div>
  
  <textarea id="batchInput" placeholder="每行一个链接，可空格加上自定义短链 key，例如：
https://a.com abc123
https://b.com
https://example.com example"></textarea>

  <div class="button-group">
    <button id="exportCSV">导出CSV</button>
    <button id="generateBatch">生成短链</button>
  </div>

  <div id="result"></div>

  <table id="shortlinks-table">
    <thead>
      <tr>
        <th>原始链接</th>
        <th>短链</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>



<script>

// 新增文件上传处理逻辑
document.getElementById('fileUpload').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  try {
    const text = await file.text();
    document.getElementById('batchInput').value = text.replace(/\r/g, '');
    // 自动触发生成（可选）
    // await document.getElementById('generateBatch').click();
  } catch (err) {
    document.getElementById('result').innerHTML = 
      `<div style="color: red;">文件读取失败：${err.message}</div>`;
  }
});

document.getElementById('generateBatch').addEventListener('click', async () => {
  const lines = document.getElementById('batchInput').value.trim().split('\n');
  if (!lines.length) return;

  const batch = lines.map(line => {
    const parts = line.trim().split(/\s+/);
    const url = parts[0];
    const key = parts[1];
    return key ? { url, key } : { url };
  });

  try {
    const res = await fetch('/.netlify/functions/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ batch })
    });

    if (!res.ok) throw new Error(`状态码: ${res.status}`);

    const data = await res.json();
    const table = document.querySelector('#shortlinks-table');
    const tbody = table.querySelector('tbody');
    tbody.innerHTML = '';

    data.results.forEach(row => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${row.url}</td><td><a href="/s/${row.key}" target="_blank">/s/${row.key}</a></td>`;
      tbody.appendChild(tr);
    });

    table.style.display = 'table';
    document.getElementById('result').innerHTML = `<div style="color: green;">成功生成 ${data.results.length} 个短链</div>`;
  } catch (err) {
    console.error(err);
    document.getElementById('result').innerHTML = `<div style="color: red;">生成失败：${err.message}</div>`;
  }
});

document.getElementById('exportCSV').addEventListener('click', () => {
  const rows = [['原始链接', '短链']];
  document.querySelectorAll('#shortlinks-table tbody tr').forEach(tr => {
    const cols = tr.querySelectorAll('td');
    rows.push([cols[0].innerText, window.location.origin + cols[1].innerText]);
  });

  const csv = rows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'shortlinks.csv';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
});
</script>
</body>
</html>