<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>批量短链生成</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <div class="container">
    <h1>批量短链生成</h1>
    <form id="form">
      <textarea id="bulkInput" placeholder="每行一条格式：原始链接 或 原始链接,自定义短链"></textarea>
      <button type="submit" id="generateButton">生成短链</button>
    </form>

    <div id="shortlinks-section">
      <table id="shortlinks-table">
        <thead>
          <tr>
            <th>原始链接</th>
            <th>短链</th>
            <th>状态</th>
          </tr>
        </thead>
        <tbody id="shortlinks-body"></tbody>
      </table>
    </div>

    <button id="exportCSV">导出 CSV</button>
  </div>

  <script>
    document.getElementById("form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const rows = document.getElementById("bulkInput").value.trim().split("\n");
      const tbody = document.getElementById("shortlinks-body");
      tbody.innerHTML = "";
      const results = [];

      for (let line of rows) {
        const [url, customKey] = line.split(",").map(s => s.trim());
        if (!url) continue;

        const tr = document.createElement("tr");
        const tdUrl = document.createElement("td");
        const tdShort = document.createElement("td");
        const tdStatus = document.createElement("td");
        tdUrl.textContent = url;
        tdShort.textContent = "生成中...";
        tdStatus.textContent = "...";

        tr.appendChild(tdUrl);
        tr.appendChild(tdShort);
        tr.appendChild(tdStatus);
        tbody.appendChild(tr);

        try {
          const res = await fetch('/.netlify/functions/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(customKey ? { url, key: customKey } : { url })
          });

          const data = await res.json();
          if (res.ok && data.key) {
            const shortUrl = `${window.location.origin}/s/${data.key}`;
            tdShort.innerHTML = `<a href="${shortUrl}" target="_blank">${shortUrl}</a>`;
            tdStatus.textContent = data.existing ? '已存在' : '新建成功';
            results.push([url, shortUrl, data.existing ? '已存在' : '新建']);
          } else {
            tdShort.textContent = "-";
            tdStatus.textContent = data.error || '失败';
            results.push([url, '-', data.error || '失败']);
          }
        } catch (err) {
          tdShort.textContent = "-";
          tdStatus.textContent = '网络错误';
          results.push([url, '-', '网络错误']);
        }
      }

      document.getElementById("exportCSV").onclick = () => {
        const csv = [
          ['原始链接', '短链', '状态'],
          ...results
        ].map(row => row.map(val => `"${val.replace(/"/g, '""')}"`).join(",")).join("\n");

        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", "shortlinks.csv");
        link.click();
      };
    });
  </script>
</body>
</html>