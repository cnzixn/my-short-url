<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>618.SH</title>
  <link rel="stylesheet" href="/style.css">
  <style>
    /* 新增加载状态样式 */
    .loading {
      display: none;
      text-align: center;
      margin: 1rem 0;
    }

    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border-left-color: #09f;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 10px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* 禁用按钮样式 */
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>批量短链生成</h1>
  
  <textarea id="batchInput" placeholder="每行一个链接，可空格加上自定义短链 key，例如：
https://a.com abc123
https://b.com
https://example.com example"></textarea>


  <input type="file" id="fileUpload" accept=".txt" />

  <div class="button-group">
    <button id="exportCSV">导出CSV</button>
    <button id="generateBatch">生成短链</button>
  </div>

  <div id="loading" class="loading">
    <div class="spinner"></div>
    <span>正在处理，请勿关闭页面...</span>
  </div>

  <div id="result"></div>

  <table id="shortlinks-table">
    <thead>
      <tr>
        <th>短链</th>
        <th>原链</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
// 新增文件上传处理逻辑
document.getElementById('fileUpload').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  try {
    const text = await file.text();
    document.getElementById('batchInput').value = text.replace(/\r/g, '');
  } catch (err) {
    document.getElementById('result').innerHTML = 
      `<div style="color: red;">文件读取失败：${err.message}</div>`;
  }
});

document.getElementById('generateBatch').addEventListener('click', async () => {
  const generateBtn = document.getElementById('generateBatch');
  const loadingDiv = document.getElementById('loading');
  const resultDiv = document.getElementById('result');
  const tableBody = document.querySelector('#shortlinks-table tbody');

  try {
    // 禁用按钮并显示加载状态
    generateBtn.disabled = true;
    loadingDiv.style.display = 'block';
    resultDiv.innerHTML = '';
    tableBody.innerHTML = '';

    const lines = document.getElementById('batchInput').value.trim().split('\n');
    if (!lines.length) return;

    const batch = lines.map(line => {
      const parts = line.trim().split(/\s+/);
      return { url: parts[0], key: parts[1] || '' };
    });

    const res = await fetch('/.netlify/functions/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ batch })
    });

    if (!res.ok) throw new Error(`状态码: ${res.status}`);
    const data = await res.json();

    // 更新表格
    data.results.forEach(row => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>
          <a href="${window.location.origin}/s/${row.key}" 
             target="_blank"
             title="完整路径：${window.location.origin}/s/${row.key}">
            ${row.key}
          </a>
        </td>
        <td>${row.url}</td>
      `;
      tableBody.appendChild(tr);
    });

    resultDiv.innerHTML = `<div style="color: green;">✅ 成功生成 ${data.results.length} 个短链</div>`;
  } catch (err) {
    resultDiv.innerHTML = `<div style="color: red;">❌ 生成失败：${err.message}</div>`;
  } finally {
    // 恢复界面状态
    generateBtn.disabled = false;
    loadingDiv.style.display = 'none';
  }
});

document.getElementById('exportCSV').addEventListener('click', () => {
  const rows = [['短链', '原链']];
  document.querySelectorAll('#shortlinks-table tbody tr').forEach(tr => {
    const cols = tr.querySelectorAll('td');
    rows.push([
      `${window.location.origin}/s/${cols[0].innerText}`,
      cols[1].innerText
    ]);
  });

  const txtContent = [
    rows[0].join('    '),
    ...rows.slice(1).map(row => row.join('    '))
  ].join('\n');

  const blob = new Blob([txtContent], { type: 'text/plain;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'shortlinks.txt';
  link.click();
});
</script>
</body>
</html>
